name: Windows Remote Debug

on:
  workflow_dispatch:  # 수동으로 실행

jobs:
  debug:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync

    - name: Show environment info
      run: |
        echo "Python version:"
        uv run python --version
        echo ""
        echo "Installed packages:"
        uv pip list
        echo ""
        echo "Working directory:"
        pwd
        echo ""
        echo "Files:"
        ls

    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 0

        # 비밀번호 설정
        $password = "P@ssw0rd123!"
        net user runneradmin $password

        Write-Host "============================================"
        Write-Host "RDP Enabled"
        Write-Host "Username: runneradmin"
        Write-Host "Password: $password"
        Write-Host "============================================"

    - name: Download and Setup Bore Tunnel (Free TCP Tunnel)
      run: |
        # Bore 다운로드 (무료, 인증 불필요, TCP 전용)
        Invoke-WebRequest -Uri "https://github.com/ekzhang/bore/releases/latest/download/bore-v0.5.1-x86_64-pc-windows-msvc.zip" -OutFile "bore.zip"
        Expand-Archive -Path "bore.zip" -DestinationPath "."

        Write-Host "============================================"
        Write-Host "Starting Bore TCP Tunnel..."
        Write-Host "============================================"

        # RDP 포트(3389)를 bore.pub으로 터널링
        Start-Process -FilePath ".\bore.exe" -ArgumentList "local 3389 --to bore.pub" -NoNewWindow -RedirectStandardOutput "tunnel.log" -RedirectStandardError "tunnel_err.log"

        Write-Host "Waiting for tunnel to start..."
        Start-Sleep -Seconds 10

        # 로그 확인
        $maxAttempts = 20
        $attempt = 0
        $port = $null

        while ($attempt -lt $maxAttempts -and $null -eq $port) {
          Start-Sleep -Seconds 2

          if (Test-Path "tunnel.log") {
            $content = Get-Content "tunnel.log" -Raw

            # "listening at bore.pub:XXXXX" 패턴 찾기
            if ($content -match "listening at bore\.pub:(\d+)") {
              $port = $matches[1]
              break
            }
          }

          if (Test-Path "tunnel_err.log") {
            $errContent = Get-Content "tunnel_err.log" -Raw
            if ($errContent -match "listening at bore\.pub:(\d+)") {
              $port = $matches[1]
              break
            }
          }

          $attempt++
        }

        Write-Host ""
        Write-Host "============================================"

        if ($null -ne $port) {
          Write-Host "RDP Connection via Bore Tunnel - SUCCESS!"
          Write-Host "============================================"
          Write-Host "Host: bore.pub"
          Write-Host "Port: $port"
          Write-Host "Username: runneradmin"
          Write-Host "Password: P@ssw0rd123!"
          Write-Host ""
          Write-Host "Connect from your Mac using Microsoft Remote Desktop:"
          Write-Host "1. Open Microsoft Remote Desktop"
          Write-Host "2. Add PC"
          Write-Host "3. PC name: bore.pub:$port"
          Write-Host "4. User account: runneradmin / P@ssw0rd123!"
          Write-Host "5. Connect!"
          Write-Host "============================================"
        } else {
          Write-Host "WARNING: Could not detect tunnel port"
          Write-Host "============================================"
          Write-Host "Tunnel log:"
          if (Test-Path "tunnel.log") {
            Get-Content "tunnel.log"
          }
          Write-Host ""
          Write-Host "Tunnel errors:"
          if (Test-Path "tunnel_err.log") {
            Get-Content "tunnel_err.log"
          }
        }

    - name: Show connection info and keep alive
      run: |
        Write-Host ""
        Write-Host "============================================"
        Write-Host "Session is active for 30 minutes"
        Write-Host "============================================"
        Write-Host "Working directory: $PWD"
        Write-Host ""
        Write-Host "To test the app after connecting via RDP:"
        Write-Host "  1. Open PowerShell on the RDP session"
        Write-Host "  2. cd D:\a\srtmacro\srtmacro"
        Write-Host "  3. uv run main.py"
        Write-Host ""
        Write-Host "The GUI will appear on the RDP desktop!"
        Write-Host "============================================"

        # 30분 동안 유지
        for ($i = 0; $i -lt 360; $i++) {
          Start-Sleep -Seconds 5

          # 30초마다 터널 상태 확인
          if ($i % 6 -eq 0) {
            $minutes = [math]::Floor($i * 5 / 60)
            Write-Host "Session active for $minutes minutes..."

            # 터널 로그 확인
            if (Test-Path "tunnel.log") {
              $logSize = (Get-Item "tunnel.log").Length
              Write-Host "  Tunnel log size: $logSize bytes"
            }
          }
        }

        Write-Host "Session timeout reached (30 minutes)."
