name: Windows Remote Debug

on:
  workflow_dispatch:  # 수동으로 실행

jobs:
  debug:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync

    - name: Show environment info
      run: |
        echo "Python version:"
        uv run python --version
        echo ""
        echo "Installed packages:"
        uv pip list
        echo ""
        echo "Working directory:"
        pwd
        echo ""
        echo "Files:"
        ls

    - name: Enable RDP
      run: |
        # RDP 활성화
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 0

        # 비밀번호 설정
        net user runneradmin "P@ssw0rd123!"

        Write-Host "============================================"
        Write-Host "RDP has been enabled"
        Write-Host "Username: runneradmin"
        Write-Host "Password: P@ssw0rd123!"
        Write-Host "============================================"

    - name: Setup tmate session (SSH tunnel)
      uses: mxschmitt/action-tmate@v3
      timeout-minutes: 30
      with:
        limit-access-to-actor: true

    - name: Show RDP connection instructions
      if: always()
      run: |
        Write-Host ""
        Write-Host "============================================"
        Write-Host "How to connect via RDP through SSH tunnel:"
        Write-Host "============================================"
        Write-Host ""
        Write-Host "1. From the tmate session above, get the SSH connection string"
        Write-Host "   Example: ssh <random>@nyc1.tmate.io"
        Write-Host ""
        Write-Host "2. On your Mac, create SSH tunnel with port forwarding:"
        Write-Host "   ssh -L 3389:localhost:3389 <random>@nyc1.tmate.io"
        Write-Host ""
        Write-Host "3. Open Microsoft Remote Desktop and connect to:"
        Write-Host "   Host: localhost:3389"
        Write-Host "   Username: runneradmin"
        Write-Host "   Password: P@ssw0rd123!"
        Write-Host ""
        Write-Host "4. After connecting, open PowerShell and run:"
        Write-Host "   cd D:\a\srtmacro\srtmacro"
        Write-Host "   uv run main.py"
        Write-Host ""
        Write-Host "You will see the GUI application on your screen!"
        Write-Host "============================================"
