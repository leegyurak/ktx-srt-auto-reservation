name: Windows Remote Debug

on:
  workflow_dispatch:  # 수동으로 실행

jobs:
  debug:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync

    - name: Show environment info
      run: |
        echo "Python version:"
        uv run python --version
        echo ""
        echo "Installed packages:"
        uv pip list
        echo ""
        echo "Working directory:"
        pwd
        echo ""
        echo "Files:"
        ls

    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 0

        # 비밀번호 설정
        $password = "P@ssw0rd123!"
        net user runneradmin $password

        Write-Host "============================================"
        Write-Host "RDP Enabled"
        Write-Host "Username: runneradmin"
        Write-Host "Password: $password"
        Write-Host "============================================"

    - name: Setup Cloudflare Tunnel (Free)
      run: |
        # Cloudflared 다운로드 (무료, 인증 불필요)
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"

        # RDP 포트(3389)를 Cloudflare 터널로 노출
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url tcp://localhost:3389" -NoNewWindow -RedirectStandardOutput "tunnel.log" -RedirectStandardError "tunnel_err.log"

        Write-Host "Waiting for tunnel to start..."
        Start-Sleep -Seconds 15

        # 로그에서 터널 URL 찾기
        if (Test-Path "tunnel.log") {
          $content = Get-Content "tunnel.log" -Raw
          Write-Host "============================================"
          Write-Host "Cloudflare Tunnel Log:"
          Write-Host $content
          Write-Host "============================================"

          # trycloudflare.com URL 추출
          if ($content -match "(https://[a-z0-9-]+\.trycloudflare\.com)") {
            $tunnelUrl = $matches[1]
            Write-Host ""
            Write-Host "============================================"
            Write-Host "RDP Connection via Cloudflare Tunnel"
            Write-Host "============================================"
            Write-Host "Tunnel URL: $tunnelUrl"
            Write-Host "Username: runneradmin"
            Write-Host "Password: P@ssw0rd123!"
            Write-Host ""
            Write-Host "How to connect from your Mac:"
            Write-Host "1. Install cloudflared:"
            Write-Host "   brew install cloudflare/cloudflare/cloudflared"
            Write-Host ""
            Write-Host "2. Create local tunnel:"
            Write-Host "   cloudflared access tcp --hostname $tunnelUrl --url localhost:3389"
            Write-Host ""
            Write-Host "3. Connect via Microsoft Remote Desktop to:"
            Write-Host "   Host: localhost:3389"
            Write-Host "   Username: runneradmin"
            Write-Host "   Password: P@ssw0rd123!"
            Write-Host "============================================"
          }
        }

        if (Test-Path "tunnel_err.log") {
          Write-Host ""
          Write-Host "Tunnel errors (if any):"
          Get-Content "tunnel_err.log"
        }

    - name: Show connection info and keep alive
      run: |
        Write-Host ""
        Write-Host "============================================"
        Write-Host "Session is active for 30 minutes"
        Write-Host "============================================"
        Write-Host "Working directory: $PWD"
        Write-Host ""
        Write-Host "To test the app after connecting via RDP:"
        Write-Host "  1. Open PowerShell on the RDP session"
        Write-Host "  2. cd D:\a\srtmacro\srtmacro"
        Write-Host "  3. uv run main.py"
        Write-Host ""
        Write-Host "The GUI will appear on the RDP desktop!"
        Write-Host "============================================"

        # 30분 동안 유지
        for ($i = 0; $i -lt 360; $i++) {
          Start-Sleep -Seconds 5

          # 30초마다 터널 상태 확인
          if ($i % 6 -eq 0) {
            $minutes = [math]::Floor($i * 5 / 60)
            Write-Host "Session active for $minutes minutes..."

            # 터널 로그 확인
            if (Test-Path "tunnel.log") {
              $logSize = (Get-Item "tunnel.log").Length
              Write-Host "  Tunnel log size: $logSize bytes"
            }
          }
        }

        Write-Host "Session timeout reached (30 minutes)."
