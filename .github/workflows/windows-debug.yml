name: Windows Remote Debug

on:
  workflow_dispatch:  # 수동으로 실행

jobs:
  debug:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync

    - name: Show environment info
      run: |
        echo "Python version:"
        uv run python --version
        echo ""
        echo "Installed packages:"
        uv pip list
        echo ""
        echo "Working directory:"
        pwd
        echo ""
        echo "Files:"
        ls

    - name: Enable RDP Access
      run: |
        # RDP 활성화
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        # 사용자 비밀번호 설정
        $password = "GithubActions123!"
        net user runneradmin $password

        Write-Host "============================================"
        Write-Host "RDP is now enabled!"
        Write-Host "Username: runneradmin"
        Write-Host "Password: $password"
        Write-Host "============================================"

    - name: Setup ngrok for RDP
      run: |
        # ngrok 다운로드 및 설치
        Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
        Expand-Archive -Path "ngrok.zip" -DestinationPath "."

        # RDP 포트(3389)를 ngrok으로 터널링
        Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --log stdout" -NoNewWindow -RedirectStandardOutput "ngrok.log"
        Start-Sleep -Seconds 10

        # ngrok URL 확인
        try {
          $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels"
          $publicUrl = $response.tunnels[0].public_url
          $host = $publicUrl -replace "tcp://", ""

          Write-Host "============================================"
          Write-Host "RDP Connection Details:"
          Write-Host "Host: $host"
          Write-Host "Username: runneradmin"
          Write-Host "Password: GithubActions123!"
          Write-Host "============================================"
          Write-Host ""
          Write-Host "Connect using Microsoft Remote Desktop:"
          Write-Host "1. Open Microsoft Remote Desktop"
          Write-Host "2. Add PC with address: $host"
          Write-Host "3. Enter username and password above"
          Write-Host "============================================"
        } catch {
          Write-Host "Waiting for ngrok to start..."
          Start-Sleep -Seconds 5
          Get-Content "ngrok.log"
        }

    - name: Keep runner alive
      run: |
        Write-Host "Session is active. Connect via RDP to debug."
        Write-Host "Working directory: $PWD"
        Write-Host "To run the app: uv run main.py"
        Write-Host ""
        Write-Host "This session will remain active for 30 minutes..."
        Start-Sleep -Seconds 1800
